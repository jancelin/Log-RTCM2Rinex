# ======================
# Centipede RTCM logger + RINEX (CRX) daily archive
# All times are UTC
# ======================

TZ=UTC

# ----------------------
# Logging verbosity (storage)
# ----------------------
# Global log level used by logger-manager + converter:
#   ERROR | WARN | INFO | DEBUG
#
# NOTE: DEBUG can generate a lot of disk usage (RTKLIB console output).
LOG_LEVEL=INFO

# Per-station monitoring events written to: $PUB_ROOT/logs/events/<MP>.events.log
# Recommended for production: WARN (only outages + abnormal restarts)
STATION_EVENTS_LEVEL=WARN

# Capture per-station RTKLIB console output into: $PUB_ROOT/logs/events/<MP>.log
# This is extremely verbose (status line every ~5s). Default: auto (enabled only in DEBUG).
STATION_CAPTURE_LOG=auto


# Host user id/group id (so files are created with your user ownership on the host)
PUID=1000
PGID=1000

# NTRIP default credentials + caster
NTRIP_HOST=crtk.net
NTRIP_PORT=2101
NTRIP_USER=centipede
NTRIP_PASS=centipede

# Root export (will contain /pub/centipede_30s/...)
PUB_ROOT=/data/pub

# Sorties
RINEX_OUT_ROOT_DAILY=/data/pub/centipede_30s
RINEX_OUT_ROOT_HOURLY=/data/pub/centipede_1s

# Produits
# Les services converter1s/converter30s surchargent ces flags via docker-compose.
RINEX_DAILY_ENABLE=false   # overridden by docker-compose (converter30s)
RINEX_DAILY_INTERVAL_S=30

RINEX_HOURLY_ENABLE=false  # overridden by docker-compose (converter1s)
RINEX_HOURLY_INTERVAL_S=1

# Edge hours (include RTCM files around the target window; convbin time filter (-ts/-te) keeps only desired epochs)
RINEX_HOURLY_EDGE_HOURS=1
RINEX_DAILY_EDGE_HOURS=1

# Planning UTC
RINEX_HOURLY_AT_MINUTE=3     # HH:03 UTC (heure précédente)
RINEX_DAILY_AT=00:20         # 00:20 UTC (jour précédent)

TMP_ROOT=/tmp

# ----------------------
# Optimisation I/O : tmpfs (RAM) pour les fichiers temporaires de conversion
# ----------------------
# Les converters utilisent FORCE_TMP_ROOT=/dev/shm/<nom> (défini dans docker-compose.yml)
# ce qui écrase TMP_ROOT ci-dessus pour les containers de conversion.
#
# SHM_MIN_FREE_MB : espace minimum exigé (MiB) sur un candidat tmp avant de l'utiliser.
# Si /dev/shm n'a pas assez de place, le converter bascule automatiquement sur $PUB_ROOT/tmp.
# Calibré pour 1 job individuel (RTCM edge + RNX brut + CRX + marge de sécurité).
#   → converter1s  : ~200 Mo par job × 7 parallel = ~1,4 Go  (shm_size: 2g dans docker-compose)
#   → converter30s : ~350 Mo par job × 7 parallel = ~2,5 Go  (shm_size: 4g dans docker-compose)
# Augmenter si vous observez des WARN "pick_tmp_root: skip /dev/shm" dans les logs.
SHM_MIN_FREE_MB=512

# ----------------------
# str2str logging
# ----------------------
# Rotate RTCM files every N hours (1 = hourly, 24 = daily)
RTCM_ROTATE_HOURS=1
# -f (swap margin, seconds)
RTCM_SWAP_MARGIN_S=0
# str2str network robustness
STR2STR_TIMEOUT_MS=10000
STR2STR_RECONNECT_MS=10000
# RTKLIB trace level (0..5). Trace file stored per station.
STR2STR_TRACE_LEVEL=2
# RTCM file suffix in filenames
RTCM_SUFFIX=GNSS-1

# "base down" watchdog: log event if no new RTCM file updated for this duration
STALE_CHECK_EVERY_SEC=60
STALE_AFTER_SEC=300

# ----------------------
# RINEX conversion (convbin) + Hatanaka (rnx2crx) + gzip
# ----------------------
RINEX_VERSION=3.04
# RINEX sampling interval in seconds (default 30s)
RINEX_INTERVAL_S=30

# RTKLIB convbin frequency mask passed as: convbin -f <mask>
# IMPORTANT: keep the SAME value for converter services and rinex-backfill scripts,
# otherwise you will get different "SYS / # / OBS TYPES" in the RINEX header.
#
# Typical value used by this project: 4
# If you set 1, output becomes minimal (often L1-only) and many observables disappear.
CONVBIN_FREQ=4

# Conversion UTC window: between start and end (HH:MM), runs every N minutes
CONVERT_WINDOW_START=00:00
CONVERT_WINDOW_END=03:00
CONVERT_EVERY_MIN=30
# Convert yesterday by default (1 = yesterday, 0 = today)
CONVERT_DAYS_BACK=1
# Parallelism when converting multiple stations
CONVERT_PARALLEL=7

# Parallelism for backfill scripts (per hour, across stations)
# If unset, scripts fall back to CONVERT_PARALLEL.
BACKFILL_PARALLEL=7
# Parallelism for daily backfill scripts (per day, across stations)
BACKFILL_DAILY_PARALLEL=7


# Output: generate .crx.gz (Hatanaka compressed)
RINEX_HATANAKA=true
RINEX_GZIP=true
# Remove duplicated epoch blocks in generated RINEX before Hatanaka compression
RINEX_DEDUP_EPOCHS=true

#web
NGINX_PORT=81


# ----------------------
# Healthchecks (seconds)
# ----------------------
LOGGER_HEALTH_MAX_AGE_SEC=120
CONVERTER_HEALTH_MAX_AGE_SEC=180

# ----------------------
# Retention / cleanup (days)
# 0 = disabled
# ----------------------
# Delete raw RTCM files older than N days (recommended: 3..14)
RTCM_RETENTION_DAYS=0
# Delete str2str traces older than N days
TRACE_RETENTION_DAYS=0
# Delete event logs older than N days
EVENTS_RETENTION_DAYS=0
# Delete temp files under $PUB_ROOT/tmp older than N days
TMP_RETENTION_DAYS=0
# Daily cleanup time (UTC)
CLEANUP_AT=01:10

# ----------------------
# Optional: querydb (auto-génération hourly de /config/stations.list depuis PostgreSQL)
#
# Activer via Docker Compose profiles :
#   docker compose --profile querydb up -d --build
#
# ---- RINEX header defaults ----
# RENAG-like defaults for serial numbers (REC # and ANT #)
RINEX_REC_NUM_DEFAULT=UNKNOWN
RINEX_ANT_NUM_DEFAULT=UNKNOWN

# Antenna delta defaults (meters) if not provided per station
RINEX_ANT_HGT_DEFAULT=0.0

# ---- querydb (optional) ----
# Enable container with: docker compose --profile querydb up -d --build
# Source view is expected to provide the stations.list columns:
#   mp, rinex_id, x, y, z, rec_type, rec_ver, ant_type, ant_h, ant_e, ant_n
# NOTE: internal spaces in rec_type/rec_ver/ant_type are encoded as '|' in stations.list.
QUERYDB_VIEW=public.station_list_source
QUERYDB_ORDER_BY=mp
QUERYDB_INTERVAL_SECONDS=3600
QUERYDB_OUTPUT=/config/stations.list

# WHERE clause (optional): e.g. "is_active = true AND country = 'FRA'"
# No 'WHERE' keyword here, only the condition.
QUERYDB_WHERE="mp = 'CT02'"

# Connection
QUERYDB_PGHOST=host.docker.internal
QUERYDB_PGPORT=5432
QUERYDB_PGDATABASE=centipede
QUERYDB_PGUSER=centipede_readonly
QUERYDB_PGPASSWORD=CHANGE_ME
QUERYDB_PGSSLMODE=disable

# Antenna deltas defaults (m) if missing in the DB view
QUERYDB_ANT_H_DEFAULT=0.0
QUERYDB_ANT_E_DEFAULT=0.0
QUERYDB_ANT_N_DEFAULT=0.0
